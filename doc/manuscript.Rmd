---
output:
  word_document: default
  html_document: default
---

# Title page #

Title: Urinary Vitamin D Binding Protein Loss as a Potential Biomarker for Diabetic Nephropathy in Patients at Risk for Type 2 Diabetes

Author: Windy ZN Wang

Affiliations: University of Toronto

Disclaimers:

Correspondence: windy.wang@mail.utoronto.ca

Funding support: CIHR, Sharon Zeiler, BBDC Novo Nordisk, Dairy Farmers

Abstract
========

Background
==========

Methods
=======

Subjects
--------

<!--
## Load data ##
-->

```{r setup, collapse=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

# Only set if the Rmd file is not in the parent directory (ie. 'projectname/')
knitr::opts_knit$set(root.dir = '../')

knitr::opts_chunk$set(collapse = TRUE, echo = FALSE, message = FALSE, warning = FALSE)
library(dplyr)
devtools::load_all()
load_data(update = TRUE)
set_options()
# extrafont::loadfonts(device="win")
```

```{r loadData, message=FALSE}

# source('.Rprofile')
# run_setup()
# load_data('data/project_data.rda')
# dim(ds)
ds <- project_data

# dsComplete <- ds %>% 
#   dplyr::group_by(SID) %>%
#   dplyr::filter(n() == 3) %>%
#   dplyr::ungroup()
```

```{r caption_setup}

## Include captions below using `captioner` package

figNums <- captioner::captioner(prefix = 'Figure')
supFigNums <- captioner::captioner(prefix = 'Supplementary Figure')
tabNums <- captioner::captioner(prefix = 'Table')
supTabNums <- captioner::captioner(prefix = 'Supplementary Table')
```

RESULTS
=======

TABLE 1: Subject characteristics across UDBP tertiles

```{r}

sub_char_table <- tableone::CreateTableOne(
  vars = c("Age",
           "Sex",
           "Ethnicity",
           "BMI",
           "Waist",
           "eGFR",
           "ACR",
           "UrineCreatinine",
           "UrineMicroalbumin",
           "UrinaryCalcium",
           "UDBP",
           "Systolic",
           "Diastolic",
           "MeanArtPressure"),
  strata = c("UDBPQuartile"),
  data = ds,
  factorVars = c("Sex", "Ethnicity")
) %>% 
  print(nonnormal = c("UDBP",
                      "ACR",
                      "UrineMicroalbumin"),
        quote = FALSE,
        noSpaces = TRUE)
```

```{r}

# Transformed using log
ds %>% 
  dplyr::select(udbpCrRatio, UDBP, fVN) %>% 
  box_plot("fVN", "log(udbpCrRatio)",
           "Visit Number", "log UDBP:Creatinine")

# ANOVA Transformed
anova <- aov(formula = log(udbpCrRatio)~fVN, data = ds)
summary(anova)
TukeyHSD(anova)
rm(anova)

# Untransformed
ds %>% 
  dplyr::select(udbpCrRatio, UDBP, fVN) %>% 
  box_plot("fVN", "udbpCrRatio",
           "Visit Number", "UDBP:Creatinine")

# ANOVA Untransformed
anova <- aov(formula = udbpCrRatio~fVN, data = ds)
summary(anova)
TukeyHSD(anova)
rm(anova)
```


Paper 1: Kidney Measures
------------------------

Albuminuriar as assessed by albumin-to-creatinine ratio

```{r acr}

# Clean data
acr <- ds %>% 
  filter(fVN == "Baseline") %>% 
  select(acrStatus, udbpCrRatio) %>%
  na.omit()

# Box plot of uVDBP in different albuminuria categories
acr %>% 
  box_plot("acrStatus", "log(udbpCrRatio)", 
            "Albuminuria",
            "log uVDBP:Creatinine")

# n
acr %>% 
  group_by(acrStatus) %>% 
  summarise(n = n())

# ANOVA
anova <- aov(formula = log(udbpCrRatio)~acrStatus, data = acr)
summary(anova)
TukeyHSD(anova)
rm(anova)
```


```{r acr scatterplot}

# Scatterplot of ACR and uVDBP ----------------------------------

ds %>% 
  filter(fVN == "Baseline") %>% 
  scatter_plot("log(ACR)", "log(udbpCrRatio)",
               "log Albumin:Creatinine Ratio",
               "log UDBP:Creatinine")

# Spearman Correlation ------------------------------------------

ds %>% 
  filter(fVN == "Baseline") %>% 
  cor.test(formula = ~ ACR + udbpCrRatio, data = ., method = "spearman")

# Linear Regression ---------------------------------------------

ds %>%
  prep_mason_data() %>% 
  mason::design("glm") %>% 
  mason::add_settings(family = stats::gaussian()) %>% 
  mason::add_variables("yvars", "ACR") %>% 
  mason::add_variables("xvars", "udbpCrRatio") %>% 
  mason::construct() %>% 
  # mason::add_variables("covariates", c("DM", "MedsBloodPressure")) %>%
  # mason::construct() %>%
  # mason::add_variables("yvars", "VitaminD") %>% 
  # mason::add_variables("xvars", "UDBP") %>% 
  # mason::construct() %>% 
  mason::scrub()

ds %>% 
  prep_mason_data() %>% 
  mason_glm(y = "ACR",
            x = "udbpCrRatio",
            covars = c("ageBase", "Sex", "Ethnicity", "fDM", "fMedsBP")
            )
  
```

Medication

* There are 705 values across all time points with blood pressure medication data
* This is approximately half of all observations (1852 vs 705)
* CHECK IF MISSINGNESS == NOT TAKING OR REALLY MISSING!!

```{r med}

ds_med <- ds %>% 
  dplyr::select(SID, VN, fMedsBP) %>% 
  na.omit()
```

Generalized Estimating Equations

```{r gee_analysis}

ds %>% 
  prep_mason_data() %>% 
  analyze_gee(y = c("ACR", "eGFR"),
              x = "UDBP",
              covars = c("VN", "ageBase", "Sex", "Ethnicity", "BMI", "fDM"))
```

```{r gee_plot}

gee %>% 
  dplyr::mutate(Xterms = term) %>% 
  dplyr::filter(!term == "(Intercept)") %>% 
  dplyr::mutate(Yterms = factor(Yterms, 
                                levels = c("ACR", "eGFR"),
                                ordered = TRUE),
                Xterms = factor(Xterms,
                                levels = rev(c("<-Xterm",
                                           "VN",
                                           "ageBase",
                                           "SexMale",
                                           "EthnicityEuropean",
                                           "BMI",
                                           "fDMdiabetes")),
                                labels = rev(c("uVDBP (ug/mL)",
                                           "Follow-up Duration (Years)",
                                           "Baseline Age (Years)",
                                           "Sex (male)",
                                           "Ethnicity (European)",
                                           "BMI (kg/m^2)",
                                           "Diabetes")),
                                ordered = TRUE)) %>% 
  arrange(Xterms) %>% 
  gee_plot(xlab = "Unit difference with 95% CI in outcome for every unit increase in uVDBP and covariates")
```

UDBP over Time
```{r udbp_time}

ds %>% 
  box_plot(xvar="fVN",
           yvar="log(UDBP)",
           xlab="Visit Number",
           ylab="UDBP")

# ANOVA
anova <- aov(formula = log(UDBP)~fVN, data = ds)
summary(anova)
TukeyHSD(anova)
rm(anova)

# n
ds %>% 
  group_by(fMedsBP) %>% 
  summarise(n = n())

# By variable
ds %>%
  # dplyr::filter(MedsBloodPressure == 0) %>%
  line_plot("fVN", "log(UDBP)", "Sex", "Visit Number", "log(UDBP)")

# LOESS curve
ds %>% 
  scatter_plot("VN", "log(UDBP)", 
               "Visit Number", "log(UDBP)")

# Adjust plot to effectively differentiate data layers
plot_progress_data(ds, byvar = "dmStatus")
```


Interaction with Time

```{r interaction_vn}

# Unadjusted interaction with visit number
ds %>% 
  prep_gee_data() %>% 
  analyze_gee(y = c("ACR", "eGFR"),
              x = "UDBP",
              covars = c("VN"),
              intvar = "VN") %>% 
  dplyr::select(Yterms, Xterms, term, p.value, conf.low, conf.high, sample.total)

# Adjusted interaction with visit number
ds %>% 
  prep_gee_data() %>% 
  analyze_gee(y = c("ACR", "eGFR"),
              x = "UDBP",
              covars = c("VN", "ageBase", "Sex", "Ethnicity", "BMI", "fDM"),
              intvar = "VN") %>% 
  dplyr::select(Yterms, Xterms, term, p.value, conf.low, conf.high, sample.total)

# Unadjusted interaction with months from baseline


# Adjusted interaction with months from baseline
```




Paper 2: Vitamin D
------------------

# Discussion #

## Acknowledgements ##

# References #
